#!/usr/bin/env node

'use strict'

var argv = require('minimist')(process.argv.slice(2));
var colors = require('colors');
var _ = require('lodash');
var caseStatus = require('../lib/case-status');
var pkg = require('../package');
var fs = require('fs');
var util = require('util');


const receipt = argv.r;
const length = parseInt(argv.l);
const now = new Date();
const receiptNum = parseInt(receipt.substring(3));
const receipts = _.range(receiptNum, receiptNum + length).map(r => receipt.substr(0, 3) + r);

console.log(now.toISOString());
console.log()

Promise
  .all(receipts.map(c => (
    caseStatus(c).catch((err) => err)
  )))
  .then((statusList) => {
    if (argv.o) {
      let date = now.toISOString().replace(/[\-T:.]/g, '_').replace(/[Z]/g, '');
      fs.writeFileSync(util.format('%s_%s_%s.txt', receipt, length, date), JSON.stringify(statusList, null, 2));
    }
    return statusList;
  })
  .then(statusList => {
    statusList.forEach((status, i) => {
      console.log(status.receipt.green);

      if (!(status instanceof Error)) {
        let formMatch = status.content.match(/Form \w-\w+/);
        if (formMatch) {
          console.log(formMatch[0].yellow);
        }
        console.log('=> ' + status.title.blue.bold);
        console.log(`=> ${status.content}`);
      } else {
        console.log(`Error: ${status.message}`.red);
      }

      if (i !== statusList.length - 1) {
        console.log();
      }
    })
  })
  .catch(err => console.log(err.message.red))
